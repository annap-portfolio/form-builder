<app-input-selector (inputSelected)="onInputSelected($event)"></app-input-selector>

@if (isMobile()) {
  <p-tabs value="0">
    <p-tablist>
      <p-tab value="0">Form</p-tab>
      <p-tab value="1">Code</p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <ng-container *ngTemplateOutlet="formContent"></ng-container>
      </p-tabpanel>
      <p-tabpanel value="1">
        <ng-container *ngTemplateOutlet="codeContent"></ng-container>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
} @else {
  <div class="form-column">
    <ng-container *ngTemplateOutlet="formContent"></ng-container>
  </div>
  <div class="code-column">
    <ng-container *ngTemplateOutlet="codeContent"></ng-container>
  </div>
}

@if (isEditDialogVisible) {
  <app-field-edit-dialog
    [element]="editedElement()!"
    [isVisible]="isEditDialogVisible"
    (close)="onClose()"
    (update)="onElementUpdate($event)"
  ></app-field-edit-dialog>
}

<!-- Reusable templates -->
<ng-template #formContent>
  <h2>Form</h2>
  @if (formDefinition.children.length > 0) {
    <div class="fields" [formGroup]="form">
      @for (element of formDefinition.children; track element.id; let i = $index) {
        <ng-container *ngTemplateOutlet="renderElement; context: { $implicit: element, index: i }"></ng-container>
      }
    </div>
  } @else {
    <div class="instruction">
      <h2>Build your form</h2>
      <p>Add fields from the left to build your form.</p>
    </div>
  }
</ng-template>

<ng-template #renderElement let-element let-index="index" let-parentGroup="parentGroup" let-group="group">
  <div class="field-divider" (onDrop)="onDropDivider(index)" pDroppable></div>

  <div
    class="field-wrapper"
    [ngClass]="{ 'field-wrapper--group': isGroup(element) }"
    pDraggable
    (onDragStart)="onDragStart(index)"
    (onDrop)="onDropField(index)"
    pDroppable
  >
    @if (isField(element)) {
      <app-form-input
        [field]="element"
        [formGroup]="group ?? form"
        [isInGroup]="!!parentGroup"
        (openEditDialog)="onOpenFieldEditDialog(element)"
        (delete)="onFormElementDelete(element, parentGroup)"
        (ungroup)="onFieldUngroup(element, parentGroup)"
      ></app-form-input>
    }

    @if (isGroup(element)) {
      <div class="group" *ngIf="getFormGroup(element) as group">
        <div class="group__header">
          <h3 class="group__header__title">{{ element.label }}</h3>
          <div class="group__header__actions">
            <p-button variant="text" size="small" (click)="onOpenFieldEditDialog(element)">
              <fa-icon [icon]="faPencil" size="sm"></fa-icon>
            </p-button>
            <p-button variant="text" size="small" (click)="onFormElementDelete(element)">
              <fa-icon [icon]="faTrash" size="sm"></fa-icon>
            </p-button>
            <p-button variant="text" size="small" (click)="ungroupGroup(element)">
              <fa-icon [icon]="faLinkSlash" size="sm"></fa-icon>
            </p-button>
          </div>
        </div>
        <div class="group__fields">
          @for (child of element.children; track child.id; let j = $index) {
            <ng-container
              *ngTemplateOutlet="
                renderElement;
                context: { $implicit: child, index: j, parentGroup: element, group: group }
              "
            ></ng-container>
          }
        </div>
      </div>
    }
  </div>
</ng-template>

<ng-template #codeContent>
  <h2>Code</h2>
  <h3>TypeScript</h3>
  <pre class="generated-code"
    >{{ tsCode }}
  </pre>
  <h3>HTML</h3>
  <pre class="generated-code"
    >{{ htmlCode }}
  </pre>
</ng-template>
